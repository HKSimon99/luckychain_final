# Kiwoom Lottery 작업 내역 - 2025년 10월 20일

## 🎯 배포 정보
- **Lotto 컨트랙트**: `0x21c0ccacd367c8e7ce5ac69d17c257c34393b25f`
- **MockVRF 컨트랙트**: `0x9861859917450f80b52df7f44d9c73b68f8c6e81`
- **네트워크**: Kaia Kairos Testnet (Chain ID: 1001)
- **관리자 지갑**: `0xe4885a25c43c8d6087f8d5a1162f9b869c08c98c`

---

## ✅ 오늘 완료한 작업

### 1. 프론트엔드 "내 티켓" 섹션 추가
- ✅ 지갑 연결 시 항상 표시
- ✅ 당첨 여부 자동 확인 및 표시
- ✅ 일치 개수 표시 (6개 미만일 때)
- ✅ 당첨 티켓 하이라이트 (노란색 그라데이션, 애니메이션)
- ✅ 티켓이 없을 때 안내 메시지 표시

### 2. "상금 분배 내역" 섹션 추가
- ✅ PrizesDistributed 이벤트에서 데이터 자동 수집
- ✅ 회차별 상금 정보 표시:
  - 총 상금 (ETH)
  - 당첨자 수
  - 1인당 상금 (ETH)
- ✅ 최신 회차부터 정렬

### 3. CORS 문제 해결
- ❌ ~~JsonRpcProvider (직접 RPC 접근)~~ → CORS 차단
- ✅ **BrowserProvider (MetaMask 경유)** 사용

### 4. RPC 502 에러 해결
- ❌ ~~fromBlock: 0 (전체 블록 조회)~~ → RPC 과부하
- ✅ **최근 10만 블록만 조회** (약 1-2주 분량)

### 5. MockVRF 사용법 이해 및 테스트 성공
- ✅ 2회차 당첨번호 생성 성공
- ✅ drawId vs requestId 차이점 이해

---

## 📚 MockVRF 사용 방법 (중요!)

### 올바른 순서:
1. **회차 종료**: `endCurrentDraw()` 실행
2. **VRF 요청**: "당첨 번호 추첨" 버튼 클릭
   - 입력: **drawId** (회차 번호, 예: 2)
   - 함수: `requestRandomWinningNumbers(drawId)`
   - 결과: VRF가 **requestId** 자동 생성
3. **requestId 확인**: 
   - 방법 1: 콘솔 로그에서 확인
   - 방법 2: 이벤트 로그 조회
4. **Mock VRF 실행**: "🧪 Mock VRF (테스트용)" 버튼 클릭
   - 입력: **requestId** (VRF 요청 번호, 예: 3)
   - 함수: `fulfillRequest(requestId)`
   - 결과: 해당 회차의 당첨번호 생성

### ⚠️ 주의사항:
- **drawId** (회차 번호): 1, 2, 3, ... (로또 회차)
- **requestId** (VRF 요청 번호): 1, 2, 3, ... (순차 증가, drawId와 다를 수 있음!)
- **혼동하지 말 것**: 2회차라고 requestId가 2인 것은 아님!

### 예시:
```
1회차: drawId=1, requestId=1 ✅
1회차 다시: drawId=1, requestId=2 ✅
2회차: drawId=2, requestId=3 ✅ (이전 요청들 때문에 3번)
```

---

## 🔧 기술적 변경 사항

### frontend/src/app/page.tsx

#### 1. Provider 변경
```typescript
// Before (CORS 에러)
const provider = new ethers.JsonRpcProvider(rpcUrl);

// After (MetaMask 경유)
const provider = new ethers.BrowserProvider(window.ethereum);
```

#### 2. 이벤트 조회 최적화
```typescript
// Before (RPC 502 에러)
const events = await contract.queryFilter(filter);

// After (최근 10만 블록만)
const currentBlock = await provider.getBlockNumber();
const fromBlock = Math.max(0, currentBlock - 100000);
const events = await contract.queryFilter(filter, fromBlock, 'latest');
```

#### 3. 새로운 함수 추가
- `loadPrizeDistributions()`: 상금 분배 내역 로드
- `loadMyTickets()`: 내 티켓 로드 (당첨 여부 확인 포함)

#### 4. useEffect 추가
```typescript
// 컨트랙트와 주소가 준비되면 티켓 자동 로드
useEffect(() => {
  if (contract && address) {
    loadMyTickets();
  }
}, [contract, address]);
```

---

## 📊 현재 상태
- 현재 회차: **3회차**
- 1회차: ✅ 완료 (당첨번호 생성됨)
- 2회차: ✅ 완료 (당첨번호 생성됨)
- 3회차: 🔄 진행 중 (판매 중)

---

## 🚀 다음 작업 (TODO)

### 우선순위 높음:
1. [ ] MockVRF requestId 자동 조회 기능 추가
   - 사용자가 수동으로 입력하지 않도록
   - `vrfRequestIds(drawId)` 호출하여 자동 입력

2. [ ] UI 개선
   - [ ] 로딩 스피너 추가
   - [ ] 트랜잭션 진행 상황 표시
   - [ ] 모바일 반응형 개선

### 우선순위 중간:
3. [ ] 자동 회차 종료 기능
   - 추첨 시간 도달 시 자동 종료 (Chainlink Automation 사용)

4. [ ] 에러 처리 개선
   - 더 명확한 에러 메시지
   - 재시도 기능 추가

### 우선순위 낮음:
5. [ ] 실제 Orakl VRF로 전환
   - Mock VRF → Orakl VRF Coordinator
   - Subscription 활성화 및 설정

6. [ ] 과거 회차 조회 기능
   - 페이지네이션
   - 필터링

---

## 💡 트러블슈팅 가이드

### Q1: "내 티켓" 섹션이 안 보여요!
**A**: 지갑을 연결하셨나요? 지갑 연결 후에만 표시됩니다.

### Q2: MockVRF가 실패해요!
**A**: 
1. VRF 요청을 먼저 하셨나요?
2. requestId를 올바르게 입력하셨나요? (drawId가 아님!)
3. 콘솔 로그에서 requestId를 확인하세요.

### Q3: CORS 에러가 나요!
**A**: 이미 해결됨! BrowserProvider를 사용하도록 변경했습니다.

### Q4: RPC 502 에러가 나요!
**A**: 이미 해결됨! 최근 10만 블록만 조회하도록 변경했습니다.

---

## 📝 참고 명령어

### Foundry 사용 (WSL)
```bash
# 현재 회차 확인
cd /home/jordanoh/kiwoom-lottery/contracts
~/.foundry/bin/cast call 0x21c0ccacd367c8e7ce5ac69d17c257c34393b25f 'currentDrawId()' --rpc-url https://public-en-kairos.node.kaia.io

# 회차 정보 확인
~/.foundry/bin/cast call 0x21c0ccacd367c8e7ce5ac69d17c257c34393b25f 'draws(uint256)' 2 --rpc-url https://public-en-kairos.node.kaia.io

# 이벤트 로그 조회
~/.foundry/bin/cast logs --from-block 199309000 --to-block latest --address 0x21c0ccacd367c8e7ce5ac69d17c257c34393b25f --rpc-url https://public-en-kairos.node.kaia.io
```

---

## 🎉 성공한 기능
- ✅ 티켓 구매
- ✅ 회차 종료
- ✅ VRF 요청
- ✅ MockVRF 당첨번호 생성
- ✅ 내 티켓 조회 (당첨 여부 포함)
- ✅ 상금 분배 내역 조회

---

**작성일**: 2025년 10월 20일  
**작성자**: AI Assistant  
**프로젝트**: Kiwoom Lottery (Decentralized Lottery on Kaia Network)

